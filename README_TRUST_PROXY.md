# Express Trust Proxy ì„¤ì • ê°€ì´ë“œ

## ê°œìš”

Expressì˜ `trust proxy` ì„¤ì •ì€ **X-Forwarded-For í—¤ë”ë¥¼ í†µí•´ í´ë¼ì´ì–¸íŠ¸ì˜ ì‹¤ì œ IP ì£¼ì†Œë¥¼ ì •í™•í•˜ê²Œ íŒŒì•…**í•˜ê¸° ìœ„í•œ ë§¤ìš° ì¤‘ìš”í•œ ì„¤ì •ì…ë‹ˆë‹¤.

í”„ë¡ì‹œ(Nginx, ALB, Cloudflare ë“±)ë¥¼ ê±°ì¹œ ìš”ì²­ì—ì„œ `req.ip`ê°€ í”„ë¡ì‹œì˜ IPê°€ ì•„ë‹Œ **ì‹¤ì œ ì‚¬ìš©ì IP**ë¥¼ ê°€ë¦¬í‚¤ë„ë¡ í•˜ë ¤ë©´ ì´ ì„¤ì •ì„ ì˜¬ë°”ë¥´ê²Œ êµ¬ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

---

## X-Forwarded-For í—¤ë” êµ¬ì¡°

í”„ë¡ì‹œë¥¼ ê±°ì¹œ ìš”ì²­ì˜ `X-Forwarded-For` í—¤ë”ëŠ” ë‹¤ìŒê³¼ ê°™ì€ í˜•ì‹ì…ë‹ˆë‹¤:

```
X-Forwarded-For: 203.0.113.45, 172.31.10.25, 10.0.1.12, 127.0.0.1
```

### ê° IPì˜ ì˜ë¯¸

| ìœ„ì¹˜ | IP | ì„¤ëª… |
|------|-----|------|
| **ë§¨ ì™¼ìª½ (ì²« ë²ˆì§¸)** | `203.0.113.45` | **ì‹¤ì œ ë¸Œë¼ìš°ì € ì‚¬ìš©ìì˜ IP** (ì›ë³¸ í´ë¼ì´ì–¸íŠ¸) |
| ì¤‘ê°„ | `172.31.10.25` | **ì¤‘ê°„ í”„ë¡ì‹œ #1** (ì˜ˆ: ALB, Cloudflare Tunnel) |
| ì¤‘ê°„ | `10.0.1.12` | **ì¤‘ê°„ í”„ë¡ì‹œ #2** (ì˜ˆ: ë‚´ë¶€ ë¡œë“œë°¸ëŸ°ì„œ) |
| **ë§¨ ì˜¤ë¥¸ìª½ (ë§ˆì§€ë§‰)** | `127.0.0.1` | **Express ì§ì „ í”„ë¡ì‹œ** (ì˜ˆ: Nginx) |

---

## Trust Proxy ì‘ë™ ì›ë¦¬

ExpressëŠ” `app.set('trust proxy', N)` ì„¤ì •ì— ë”°ë¼:

1. **ì˜¤ë¥¸ìª½ë¶€í„° Nê°œì˜ IPë¥¼ ì œê±°** (ì‹ ë¢° ê°€ëŠ¥í•œ í”„ë¡ì‹œë¡œ ê°„ì£¼)
2. **ë‚¨ì•„ ìˆëŠ” IP ì¤‘ ê°€ì¥ ì˜¤ë¥¸ìª½ ê²ƒì„ `req.ip`ë¡œ ì§€ì •**

### ì˜ˆì‹œ

#### ì‹œë‚˜ë¦¬ì˜¤: í”„ë¡ì‹œ ì²´ì¸
```
X-Forwarded-For: 203.0.113.45, 172.31.10.25, 10.0.1.12, 127.0.0.1
```

#### ê° ì„¤ì •ì— ë”°ë¥¸ ê²°ê³¼

```
N=0 (ì•„ë¬´ í”„ë¡ì‹œë„ ì‹ ë¢° ì•ˆ í•¨)
â†’ req.ip = 127.0.0.1  âŒ (í”„ë¡ì‹œ IP)

N=1 (Nginx ì‹ ë¢°)
â†’ ì œê±°: 127.0.0.1
â†’ req.ip = 10.0.1.12  âŒ (ì—¬ì „íˆ í”„ë¡ì‹œ IP)

N=2 (Nginx + ALB ì‹ ë¢°)
â†’ ì œê±°: 127.0.0.1, 10.0.1.12
â†’ req.ip = 172.31.10.25  âŒ (ì—¬ì „íˆ ì¤‘ê°„ í”„ë¡ì‹œ IP)

N=3 (Nginx + ALB + Cloudflare ì‹ ë¢°)
â†’ ì œê±°: 127.0.0.1, 10.0.1.12, 172.31.10.25
â†’ req.ip = 203.0.113.45  âœ… (ì‹¤ì œ ì‚¬ìš©ì IP)
```

---

## ìƒí™©ë³„ ì„¤ì • ê°€ì´ë“œ

### 1ï¸âƒ£ í”„ë¡ì‹œ ì—†ìŒ (ë¡œì»¬ ê°œë°œ í™˜ê²½)

```javascript
app.set('trust proxy', false);
```

**ì–¸ì œ**: ê°œë°œ í™˜ê²½ì—ì„œ Nginxë‚˜ ë¡œë“œë°¸ëŸ°ì„œ ì—†ì´ ì§ì ‘ Express ì„œë²„ì— ì ‘ì†
**ê²°ê³¼**: `req.ip` = ì§ì ‘ ì—°ê²° í´ë¼ì´ì–¸íŠ¸ì˜ IP

---

### 2ï¸âƒ£ Nginxë§Œ ìˆëŠ” ê²½ìš°

```javascript
app.set('trust proxy', 1);
```

**êµ¬ì¡°**:
```
Client (203.0.113.45)
    â†“
Nginx (127.0.0.1)
    â†“
Express
```

**X-Forwarded-For**: `203.0.113.45, 127.0.0.1`
**ê²°ê³¼**: `req.ip = 203.0.113.45` âœ…

---

### 3ï¸âƒ£ Nginx + ALB ì¡°í•©

```javascript
app.set('trust proxy', 2);
```

**êµ¬ì¡°**:
```
Client (203.0.113.45)
    â†“
ALB (172.31.10.25)
    â†“
Nginx (127.0.0.1)
    â†“
Express
```

**X-Forwarded-For**: `203.0.113.45, 172.31.10.25, 127.0.0.1`
**ê²°ê³¼**: `req.ip = 203.0.113.45` âœ…

---

### 4ï¸âƒ£ Nginx + ALB + Cloudflare ì¡°í•©

```javascript
app.set('trust proxy', 3);
```

**êµ¬ì¡°**:
```
Client (203.0.113.45)
    â†“
Cloudflare (10.0.1.12)
    â†“
ALB (172.31.10.25)
    â†“
Nginx (127.0.0.1)
    â†“
Express
```

**X-Forwarded-For**: `203.0.113.45, 10.0.1.12, 172.31.10.25, 127.0.0.1`
**ê²°ê³¼**: `req.ip = 203.0.113.45` âœ…

---

## IP CIDR ê¸°ë°˜ ì„¤ì • (ê¶Œì¥)

`trust proxy`ë¥¼ **ìˆ«ì ëŒ€ì‹  IP CIDR ë²”ìœ„ ë°°ì—´**ë¡œ ì„¤ì •í•˜ë©´, ë”ìš± **ì•ˆì „í•˜ê³  ìœ ì—°í•œ êµ¬ì„±**ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

### ì„¤ì • ì˜ˆì‹œ

```javascript
app.set('trust proxy', [
  'loopback',        // 127.0.0.1, ::1 (ë¡œì»¬í˜¸ìŠ¤íŠ¸)
  '10.0.0.0/8',      // AWS VPC CIDR (ALB, EC2 í¬í•¨)
  '172.16.0.0/12',   // ì‚¬ì„¤ë§ (Cloudflare Tunnel, Wireguard ë“±)
  '192.168.0.0/16',  // ë¡œì»¬ ë„¤íŠ¸ì›Œí¬ (í™ˆ ë„¤íŠ¸ì›Œí¬ ë“±)
  '103.21.244.0/22', // Cloudflare IP ë²”ìœ„ (ì˜ˆì‹œ)
]);
```

### ê° CIDR ë²”ìœ„ì˜ ì˜ë¯¸

| CIDR | ë²”ìœ„ | í¬í•¨ë˜ëŠ” IP | ì‚¬ìš© ì‚¬ë¡€ |
|------|------|-----------|---------|
| `loopback` | 127.0.0.1, ::1 | ë¡œì»¬í˜¸ìŠ¤íŠ¸ | ë¡œì»¬ ê°œë°œ, ë™ì¼ ë¨¸ì‹ ì˜ í”„ë¡ì‹œ |
| `10.0.0.0/8` | 10.0.0.0 ~ 10.255.255.255 | AWS VPC, EC2 ë‚´ë¶€ í†µì‹  | AWS ALB, NLB |
| `172.16.0.0/12` | 172.16.0.0 ~ 172.31.255.255 | ì‚¬ì„¤ ë„¤íŠ¸ì›Œí¬ | Docker, Kubernetes, Cloudflare Tunnel |
| `192.168.0.0/16` | 192.168.0.0 ~ 192.168.255.255 | ë¡œì»¬ ë„¤íŠ¸ì›Œí¬ | í™ˆ/íšŒì‚¬ ë„¤íŠ¸ì›Œí¬, ë‚´ë¶€ ì¸íŠ¸ë¼ë„· |

---

## AWS ê¸°ë°˜ ë°°í¬ ì‹œ ì„¤ì •

### ğŸ“Œ ALB (Application Load Balancer)

ALBëŠ” EC2 ì¸ìŠ¤í„´ìŠ¤ì— ìš”ì²­ì„ ì „ë‹¬í•  ë•Œ `X-Forwarded-For` í—¤ë”ë¥¼ ìë™ìœ¼ë¡œ ì¶”ê°€í•©ë‹ˆë‹¤.

```javascript
// ALBë§Œ ìˆëŠ” ê²½ìš°
app.set('trust proxy', 1);

// ALB + Nginx êµ¬ì„±
app.set('trust proxy', 2);

// IP CIDR ê¸°ë°˜ (ê¶Œì¥)
app.set('trust proxy', ['loopback', '10.0.0.0/8']);
```

### ğŸ“Œ VPCì™€ ë³´ì•ˆ

AWS VPC ë‚´ í†µì‹ ì€ `10.0.0.0/8` CIDRë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ, ì´ ë²”ìœ„ì˜ í”„ë¡ì‹œë¥¼ ì‹ ë¢°í•˜ëŠ” ê²ƒì´ ì•ˆì „í•©ë‹ˆë‹¤.

```javascript
// VPC ë‚´ë¶€ í”„ë¡ì‹œë§Œ ì‹ ë¢° (ì™¸ë¶€ IPëŠ” ê±°ë¶€)
app.set('trust proxy', '10.0.0.0/8');
```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### 1. ìˆ«ì(`N`)ë¡œ ì„¤ì •í•  ë•Œì˜ ìœ„í—˜ì„±

```javascript
// âŒ ìœ„í—˜: ë„ˆë¬´ ë†’ì€ ìˆ«ì
app.set('trust proxy', 10);
```

í”„ë¡ì‹œ ì²´ì¸ì´ ì‹¤ì œë¡œ 10ê°œê°€ ì•„ë‹ˆë©´, ì•ˆì‹ ë¢°í•  ìˆ˜ ì—†ëŠ” í”„ë¡ì‹œì˜ IPë¥¼ ì‚¬ìš©ì IPë¡œ ê°„ì£¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 2. `true` ë¡œ ì„¤ì •í•˜ë©´ ì ˆëŒ€ ê¸ˆì§€ â›”

```javascript
// âŒ ì ˆëŒ€ í•˜ë©´ ì•ˆ ë¨!
app.set('trust proxy', true);
```

ì´ë ‡ê²Œ ì„¤ì •í•˜ë©´:
- Expressê°€ **ëª¨ë“  í”„ë¡ì‹œ(0.0.0.0/0)ë¥¼ ì‹ ë¢°**
- X-Forwarded-For í—¤ë”ë¥¼ ì™„ì „íˆ ì‹ ë¢°
- ê³µê²©ìê°€ ì„ì˜ë¡œ IPë¥¼ ì¡°ì‘í•  ìˆ˜ ìˆìŒ
- ì¸ì¦, ë¹„ìœ¨ ì œí•œ, ë¡œê¹… ë“±ì´ ë¬´íš¨í™”ë¨

### 3. í—¤ë” ì¡°ì‘ ê³µê²© ë°©ì§€

í”„ë¡ì‹œê°€ ì‹ ë¢°í•  ìˆ˜ ì—†ìœ¼ë©´ X-Forwarded-Forë¥¼ ê²€ì¦í•˜ê³ , í•„ìš”ì‹œ ë³„ë„ì˜ ì¸ì¦ ë°©ì‹ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

---

## ì„¤ì • í™•ì¸ ë°©ë²•

### 1. í˜„ì¬ ì„¤ì • í™•ì¸

```javascript
console.log(app.get('trust proxy'));
```

### 2. ìš”ì²­ì—ì„œ IP í™•ì¸

```javascript
app.get('/check-ip', (req, res) => {
  console.log('req.ip:', req.ip);
  console.log('X-Forwarded-For:', req.get('X-Forwarded-For'));
  res.json({
    ip: req.ip,
    xForwardedFor: req.get('X-Forwarded-For'),
  });
});
```

### 3. Nginx í…ŒìŠ¤íŠ¸

```bash
curl -H "X-Forwarded-For: 203.0.113.45" http://localhost:3000/check-ip
```

---

## ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] í”„ë¡ì‹œ ì²´ì¸ êµ¬ì¡°ë¥¼ ì •í™•íˆ íŒŒì•…í–ˆëŠ”ê°€?
- [ ] í”„ë¡ì‹œì˜ ê°œìˆ˜ë¥¼ ì •í™•íˆ ì„¸ì—ˆëŠ”ê°€?
- [ ] ê° í”„ë¡ì‹œ ì„œë²„ì˜ IP ë²”ìœ„ë¥¼ í™•ì¸í–ˆëŠ”ê°€?
- [ ] `trust proxy` ì„¤ì •ì´ í™˜ê²½ë³„ë¡œ ë‹¤ë¥¸ê°€? (ê°œë°œ vs ìš´ì˜)
- [ ] IP CIDR ê¸°ë°˜ ì„¤ì •ìœ¼ë¡œ ë” ì•ˆì „í•˜ê²Œ êµ¬ì„±í–ˆëŠ”ê°€?
- [ ] í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ `req.ip`ê°€ ì •í™•í•œì§€ í™•ì¸í–ˆëŠ”ê°€?
- [ ] ë¡œê¹…ì— ì˜¬ë°”ë¥¸ IPê°€ ê¸°ë¡ë˜ëŠ”ì§€ í™•ì¸í–ˆëŠ”ê°€?

---

## ì°¸ê³  ìë£Œ

- [Express Trust Proxy ê³µì‹ ë¬¸ì„œ](https://expressjs.com/en/guide/behind-proxies.html)
- [X-Forwarded-For í—¤ë” ëª…ì„¸](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-For)
- [IP CIDR ë²”ìœ„ ì°¸ì¡°](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing)
